# The cheasheet gives lot of examples to learn specifics for each language (ref: https://semgrep.dev/embed/cheatsheet)
rules:
  - id: node-extract-functions
    options:
      symbolic_propagation: true
    patterns:
      - pattern-either:
          - pattern: |
              $FUNC = (...) => { ... }
          - pattern: |
              function $FUNC(...)
      - metavariable-regex:
          # Most of the time meaningless callbacks
          metavariable: $FUNC
          regex: '^(?!on[A-Z]).*'
      - metavariable-regex:
          # Most of the time components
          metavariable: $FUNC
          regex: '^(?![A-Z]).*'
      - metavariable-pattern:
          # Exclude those being class constructor
          metavariable: $FUNC
          patterns:
            - pattern-not: 'constructor'
    message: 'Function name: $FUNC'
    languages:
      - javascript
      - typescript
    severity: ERROR
    paths:
      exclude:
        - 'tests/**/*'
        - '*.spec.js'
        - '*.spec.ts'
  - id: node-find-dependencies
    options:
      symbolic_propagation: true
    patterns:
      - pattern-either:
          - pattern: |
              {
                "dependencies": {
                  $DEPENDENCY_NAME: "$VALUE",
                  ...
                },
                ...
              }
          - pattern: |
              {
                "devDependencies": {
                  $DEPENDENCY_NAME: "$VALUE",
                  ...
                },
                ...
              }
      - metavariable-regex:
          # `$DEPENDENCY_NAME` has additional wrapping quotes for no reason (but not $VALUE), having this workaround to strip them and get core value into $1...
          metavariable: $DEPENDENCY_NAME
          regex: '^"(.*)"$'
    message: "Dependency '$DEPENDENCY_NAME' in package.json"
    languages:
      - json
    severity: ERROR
    paths:
      include:
        - 'package.json'
  - id: php-extract-functions
    options:
      symbolic_propagation: true
    patterns:
      - pattern-either:
          # No success to remove the prefix "$" since "$$FUNC" and specific `metavariable-regex` were breaking the analysis, but we are fine the LLM should handle it
          - pattern: |
              $FUNC = function (...) { ... }
          - pattern: |
              function $FUNC(...) { ... }
      - metavariable-regex:
          # Most of the time meaningless callbacks
          metavariable: $FUNC
          regex: '^(?!\$?on[A-Z]).*'
      - metavariable-pattern:
          # Exclude those being class constructor
          metavariable: $FUNC
          patterns:
            - pattern-not: '__construct'
    message: 'Function name: $FUNC'
    languages:
      - php
    severity: ERROR
    paths:
      exclude:
        - 'tests/**/*'
        - '*Test.php'
  - id: php-find-dependencies
    options:
      symbolic_propagation: true
    patterns:
      - pattern-either:
          - pattern: |
              {
                "require": {
                  $DEPENDENCY_NAME: "$VALUE",
                  ...
                },
                ...
              }
          - pattern: |
              {
                "require-dev": {
                  $DEPENDENCY_NAME: "$VALUE",
                  ...
                },
                ...
              }
      - metavariable-regex:
          # `$DEPENDENCY_NAME` has additional wrapping quotes for no reason (but not $VALUE), having this workaround to strip them and get core value into $1...
          metavariable: $DEPENDENCY_NAME
          regex: '^"(.*)"$'
    message: "Dependency '$DEPENDENCY_NAME' in composer.json"
    languages:
      - json
    severity: ERROR
    paths:
      include:
        - 'composer.json'
  - id: ruby-extract-functions
    options:
      symbolic_propagation: true
    patterns:
      - pattern-either:
          - pattern: |
              def $FUNC(...)
                ...
              end
          - pattern: |
              $FUNC = -> (...) { ... }
          - pattern: |
              $FUNC = proc { ... }
      - metavariable-regex:
          # Most of the time meaningless callbacks
          metavariable: $FUNC
          regex: '^(?!\$?on_[a-z]).*'
      - metavariable-pattern:
          # Exclude those being class constructor
          metavariable: $FUNC
          patterns:
            - pattern-not: 'initialize'
    message: 'Function name: $FUNC'
    languages:
      - ruby
    severity: ERROR
    paths:
      exclude:
        - 'tests/**/*'
        - 'spec/**/*'
        - '*_spec.rb'
  - id: ruby-find-dependencies
    options:
      symbolic_propagation: true
      generic_ellipsis_max_span: 0
    patterns:
      # Since "generic" language using basic matching of content is more complicated (the real variable name is `$...DEPENDENCY_NAME`, not `$DEPENDENCY_NAME`...)
      - pattern: gem "$...DEPENDENCY_NAME"
    message: "Dependency '$DEPENDENCY_NAME' in Gemfile"
    languages:
      # - ruby # Ideally we could easily parse the `Gemfile` as ruby file but semgrep makes it no easy at all so giving up (refs: https://github.com/semgrep/semgrep/issues/3090 and https://github.com/semgrep/semgrep/issues/1099)
      - generic
    severity: ERROR
    paths:
      include:
        - 'Gemfile'
  - id: python-extract-functions
    options:
      symbolic_propagation: true
    patterns:
      - pattern-either:
          - pattern: |
              def $FUNC(...):
                ...
      - metavariable-regex:
          # Most of the time meaningless callbacks
          metavariable: $FUNC
          regex: '^(?!\$?on_[a-z]).*'
      - metavariable-pattern:
          # Exclude those being class constructor
          metavariable: $FUNC
          patterns:
            - pattern-not: '__init__'
    message: 'Function name: $FUNC'
    languages:
      - python
    severity: ERROR
    paths:
      exclude:
        - 'tests/**/*'
        - 'test_*.py'
  - id: python-requirementstxt-find-dependencies
    options:
      symbolic_propagation: true
      generic_ellipsis_max_span: 0
    patterns:
      - pattern-regex: '^(.*?)(?==|\s|$)'
    message: "Dependency '$DEPENDENCY_NAME' in requirements.txt"
    languages:
      - generic
    severity: ERROR
    paths:
      include:
        - 'requirements.txt'
  - id: python-pipefile-find-dependencies
    options:
      symbolic_propagation: true
    patterns:
      # It was impossible to rely on `[packages] ... [` delimiters due to semgrep considering only a block with `pattern`
      # and not taking all occurences with `regex-pattern` and a delimiter. So we ended relying on precise format at the end of the line
      # even if it may match those under `[requires]` or so, but we are fine with it since they should correspond to librairies in all cases
      - pattern-regex: '^(.*?)(?=(\s+)?=(\s+)?\"(\*|.*\d.*)\")'
    message: "Dependency '$DEPENDENCY_NAME' in Pipfile"
    languages:
      - generic
    severity: ERROR
    paths:
      include:
        - 'Pipfile'
  - id: python-pyproject-find-dependencies
    options:
      symbolic_propagation: true
    patterns:
      # See explanation from the rule `python-pipefile-find-dependencies`
      - pattern-regex: '^(.*?)(?=(\s+)?=(\s+)?\"(\*|.*\d.*)\")'
    message: "Dependency '$DEPENDENCY_NAME' in pyproject.toml"
    languages:
      - generic
    severity: ERROR
    paths:
      include:
        - 'pyproject.toml'
